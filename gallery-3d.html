<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yanxu | 晨光画境</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>

    <style>
        /* === 1. 基础设置 === */
        :root {
            --text-primary: #fff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent-gold: #d4af37;
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; 
            background: #111;
            color: var(--text-primary);
            font-family: "Songti SC", "Noto Serif SC", serif;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        /* === 2. 动态背景层 === */
        .dynamic-bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; 
            pointer-events: none; 
            overflow: hidden;
        }
        
        .bg-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* 稍微调亮一点点，让背景细节可见 */
            z-index: 2;
        }

        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; transition: opacity 1.2s ease-in-out; /* 更柔和的过渡 */
            z-index: 1;
        }
        .bg-layer.active { opacity: 1; }
        
        .bg-img {
            width: 100%; height: 100%; object-fit: cover;
            filter: blur(40px) saturate(1.1) brightness(0.8);
            transform: scale(1.1);
        }

        /* === 3. 右上角控制区 === */
        .controls-area {
            position: fixed; top: 20px; right: 20px;
            z-index: 800;
            display: flex; gap: 15px; align-items: center;
        }

        .control-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.15); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0; transition: all 0.3s;
            backdrop-filter: blur(5px);
            font-size: 12px; font-weight: bold; color: #fff;
            font-family: sans-serif;
        }
        body.started .control-btn { opacity: 1; }
        .control-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        
        .music-btn svg { width: 18px; height: 18px; fill: #fff; transition: fill 0.3s; }
        .music-btn.muted svg { fill: rgba(255,255,255,0.5); }
        .music-btn.playing { animation: pulse 3s infinite; background: rgba(255,255,255,0.3); }
        
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.2); } 
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } 
        }

        /* === 4. 开场与UI === */
        .intro-section {
            height: 100vh; width: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; 
            z-index: 900; 
            position: fixed; top:0; left:0;
            background: linear-gradient(120deg, #fdfbfb 0%, #ffefd5 100%);
            transition: opacity 1s ease, visibility 1s;
        }
        .intro-section.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .intro-title { 
            font-size: 8vw; font-weight: bold; letter-spacing: 10px; margin: 0; 
            background: linear-gradient(to right, #8b5e3c, #d4af37);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .intro-subtitle { font-size: 1.2rem; color: #8c7b66; margin-top: 20px; letter-spacing: 5px; }
        
        .start-btn {
            margin-top: 50px; padding: 12px 30px;
            border: 1px solid #5e4b35; color: #5e4b35;
            font-size: 14px; letter-spacing: 2px;
            background: transparent; cursor: pointer;
            transition: all 0.3s ease;
        }
        .start-btn:hover { background: #5e4b35; color: #fff; }

        .scroll-hint { 
            position: fixed; bottom: 30px; width: 100%; text-align: center;
            font-size: 12px; color: rgba(255,255,255,0.6); 
            opacity: 0; transition: opacity 0.5s; 
            animation: float 3s infinite ease-in-out; pointer-events: none; z-index: 200;
        }
        body.started .scroll-hint { opacity: 0.6; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* === 5. 画廊轨道 === */
        .gallery-container {
            width: 100%; height: 100vh;
            overflow: hidden; display: flex; align-items: center;
            visibility: hidden;
            position: relative; 
            z-index: 10; 
        }
        body.started .gallery-container { visibility: visible; }

        .gallery-wrapper {
            display: flex; align-items: center; flex-wrap: nowrap;
            height: 100%; 
            will-change: transform;
            /* padding-left 由 JS 动态计算 */
        }

        .gallery-item {
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center;
            /* width 和 margin 由 JS 动态计算 */
            height: 100%; flex-shrink: 0;
            position: relative;
        }

        .art-card {
            position: relative; width: 100%; height: 60vh; 
            overflow: hidden; cursor: pointer;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.4s ease;
            background: white; padding: 10px;
            transform: translateZ(0);
        }
        .art-card:hover { transform: scale(1.02); box-shadow: 0 40px 80px rgba(0,0,0,0.6); }

        .art-img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.8s ease; content-visibility: auto;
        }
        .art-card:hover .art-img { transform: scale(1.05); }

        .art-preview-info {
            margin-top: 20px; text-align: left; opacity: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            transform: translateX(5px);
        }
        .art-preview-title { font-size: 20px; font-weight: bold; margin: 0 0 5px 0; letter-spacing: 2px; }
        .art-preview-meta { font-size: 13px; color: rgba(255,255,255,0.8); font-family: sans-serif; letter-spacing: 1px;}
        
        /* === 6. 详情弹窗 (优化版) === */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); /* 稍微加深背景 */
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        .modal.active { opacity: 1; pointer-events: auto; }

        .modal-content-box {
            position: relative; width: 90vw; height: 90vh; max-width: 1400px;
            background: #1a1a1a; /* 实色背景，避免杂乱 */
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
            padding: 0; /* 移除内边距，完全控制布局 */
            box-sizing: border-box; 
            display: flex; flex-direction: column; /* 上下布局 */
            transform: scale(0.96); transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            overflow: hidden;
        }
        .modal.active .modal-content-box { transform: scale(1); }

        /* 上半部分：图片区域，自动撑满 */
        .modal-img-wrapper {
            position: relative; width: 100%; 
            flex: 1; /* 关键：占据剩余所有空间 */
            display: flex; justify-content: center; align-items: center;
            background: #000;
            overflow: hidden;
            padding: 20px; /* 给图片一点呼吸空间 */
        }
        .modal-img { 
            width: auto; height: auto; 
            max-width: 100%; max-height: 100%; 
            object-fit: contain; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* 下半部分：文字区域 */
        .modal-text {
            width: 100%; 
            padding: 25px 40px;
            background: #1a1a1a;
            color: #fff;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* 桌面端左右布局优化 (如果屏幕够宽) */
        @media (min-width: 1024px) {
            .modal-content-box { flex-direction: row; }
            .modal-img-wrapper { height: 100%; width: 65%; border-right: 1px solid rgba(255,255,255,0.05); }
            .modal-text { height: 100%; width: 35%; border-top: none; justify-content: center; padding: 50px; }
        }

        .modal-title { font-size: 28px; font-weight: bold; margin: 0 0 10px 0; letter-spacing: 2px; color: var(--accent-gold); }
        .modal-meta { font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 20px; font-family: sans-serif; text-transform: uppercase; letter-spacing: 1px; }
        .modal-desc { font-size: 15px; line-height: 1.8; text-align: justify; opacity: 0.9; color: #ddd; max-height: 40vh; overflow-y: auto; padding-right: 10px;}
        
        /* 美化滚动条 */
        .modal-desc::-webkit-scrollbar { width: 4px; background: rgba(255,255,255,0.1); }
        .modal-desc::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 2px; }

        .close-btn {
            position: absolute; top: 15px; right: 15px;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; font-size: 18px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s; z-index: 100;
        }
        .close-btn:hover { background: #fff; color: #000; transform: rotate(90deg); }

        .progress-bar {
            position: fixed; bottom: 0; left: 0; height: 3px; background: var(--accent-gold);
            width: 0%; z-index: 850;
        }
        
        @media (max-width: 768px) {
            .intro-title { font-size: 12vw; }
            .art-card { height: 50vh; }
            .modal-content-box { width: 100%; height: 100%; border-radius: 0; }
            .modal-text { padding: 20px; }
            .controls-area { top: 15px; right: 15px; gap: 10px; }
            .control-btn { width: 32px; height: 32px; font-size: 10px; }
        }
    </style>
</head>
<body>

    <div class="dynamic-bg-container" id="bg-container">
        <div class="bg-overlay"></div>
    </div>

    <audio id="bg-music" loop preload="auto">
        <source src="assets/music/还是会想你曼波.mp3" type="audio/mpeg">
    </audio>

    <div class="controls-area">
        <div class="control-btn lang-btn" id="lang-btn" onclick="toggleLanguage()">EN</div>
        <div class="control-btn music-btn muted" id="music-toggle" onclick="toggleMusic()">
            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
        </div>
    </div>

    <div class="progress-bar"></div>

    <div class="modal" id="detail-modal">
        <div class="modal-content-box">
            <div class="close-btn" id="close-modal-btn">✕</div>
            <div class="modal-img-wrapper">
                <img src="" alt="" class="modal-img" id="modal-img">
            </div>
            <div class="modal-text">
                <div class="modal-title" id="m-title"></div>
                <div class="modal-meta" id="m-meta"></div>
                <div class="modal-desc" id="m-desc"></div>
            </div>
        </div>
    </div>

    <section class="intro-section" id="intro">
        <h1 class="intro-title">YANXU</h1>
        <p class="intro-subtitle" id="ui-subtitle">CHINESE PAINTING · 晨光画境</p>
        <button class="start-btn" id="ui-enter-btn" onclick="startGallery()">进入画境</button>
    </section>
    
    <div class="scroll-hint" id="ui-scroll-hint">SCROLL TO EXPLORE</div>

    <div class="gallery-container">
        <div class="gallery-wrapper" id="gallery-wrapper">
        </div>
    </div>

    <script>
        // === 数据 ===
        const uiText = {
            zh: { subtitle: "CHINESE PAINTING · 晨光画境", enterBtn: "进入画境", scrollHint: "SCROLL TO EXPLORE / 滚动探索", langBtn: "EN" },
            en: { subtitle: "CHINESE PAINTING · Art of Morning Light", enterBtn: "ENTER GALLERY", scrollHint: "SCROLL TO EXPLORE", langBtn: "中" }
        };

        const originalArtworks = [
            { id: 1, src: "assets/images/gallery/eg1.jpg", title: { zh: "晨光熹微 No.1", en: "First Light No.1" }, year: "2023 · 138x69cm", desc: { zh: "笔墨在晨光中苏醒，捕捉第一缕阳光穿透云雾的瞬间。画面运用了传统的积墨法与现代的光影构成，试图在混沌中寻找秩序与希望。", en: "Ink awakens in the morning light, capturing the moment sunlight pierces through the mist. Using traditional ink layering with modern composition, it seeks order and hope amidst chaos." } },
            { id: 2, src: "assets/images/gallery/eg2.jpg", title: { zh: "山间清风 No.2", en: "Mountain Breeze No.2" }, year: "2023 · 69x69cm", desc: { zh: "以清透的淡彩与水墨交融，表现山间清风拂过林梢的动态。留白的处理旨在营造空灵幽远的意境，强调人与自然的和谐共生。", en: "Clear watercolors blend with ink to express the breeze sweeping through treetops. The negative space creates an ethereal atmosphere, emphasizing harmony between man and nature." } },
            { id: 3, src: "assets/images/gallery/eg3.jpg", title: { zh: "古木幽鸣 No.3", en: "Ancient Echoes No.3" }, year: "2022 · 180x97cm", desc: { zh: "聚焦于古树的肌理与沧桑感。通过焦墨与宿墨的对比，强化了古木盘根错节的生命力，仿佛能听到历史的回响。", en: "Focusing on the texture and vicissitudes of ancient trees. The contrast between dry and accumulated ink highlights the intertwined vitality, echoing the sounds of history." } },
            { id: 4, src: "assets/images/gallery/eg4.jpg", title: { zh: "溪山行旅 No.4", en: "Travels in Mountains No.4" }, year: "2023 · 138x34cm", desc: { zh: "向传统宋画致敬的长卷构图。在狭长的空间中安排了多重透视，引导观者视线随溪流而上，体验可行、可望、可游的境界。", en: "A tribute to Song Dynasty landscape painting in a long scroll format. Multiple perspectives guide the viewer upstream, creating an immersive journey through the landscape." } },
            { id: 5, src: "assets/images/gallery/eg5.jpg", title: { zh: "云蒸霞蔚 No.5", en: "Rising Clouds No.5" }, year: "2024 · 90x90cm", desc: { zh: "大胆运用朱砂与石青色，描绘日出时分云蒸霞蔚的壮观景象。色彩的碰撞与融合，旨在表现自然界瞬息万变的磅礴能量。", en: "Bold use of Cinnabar and Mineral Blue depicts the magnificent sunrise. The collision of colors expresses the majestic and ever-changing energy of nature." } },
            { id: 6, src: "assets/images/gallery/eg6.jpg", title: { zh: "静谧之境 No.6", en: "Serenity No.6" }, year: "2022 · 69x45cm", desc: { zh: "一幅极简主义风格的小品。大部分画面留白，仅在角落以简练的笔触勾勒出一石一草，追求“少即是多”的禅意表达。", en: "A minimalist piece. Most of the paper is left blank, with simple strokes outlining a stone and grass in the corner, pursuing the Zen expression of 'less is more'." } },
            { id: 7, src: "assets/images/gallery/eg7.jpg", title: { zh: "雨后初晴 No.7", en: "After the Rain No.7" }, year: "2023 · 138x69cm", desc: { zh: "利用湿画法表现雨后山石润泽、空气清新的质感。画面中水气氤氲，仿佛能闻到泥土的芬芳，展现了江南烟雨的独特韵味。", en: "Using wet wash techniques to show the moist texture of rocks after rain. The misty atmosphere evokes the scent of earth, showcasing the unique charm of Jiangnan rain." } },
            { id: 8, src: "assets/images/gallery/eg8.jpg", title: { zh: "秋山红叶 No.8", en: "Autumn Hills No.8" }, year: "2023 · 120x120cm", desc: { zh: "满幅构图，以热烈的色彩表现秋山的丰富层次。墨色作为骨架，承载着斑斓的色彩，旨在传达秋天丰饶而深沉的情绪。", en: "Full composition using warm colors to show the rich layers of autumn hills. Ink serves as the skeleton supporting vibrant colors, conveying the richness and depth of autumn." } },
            { id: 9, src: "assets/images/gallery/eg9.jpg", title: { zh: "寒江独钓 No.9", en: "Solitary Fishing No.9" }, year: "2022 · 69x69cm", desc: { zh: "取材于传统诗意，但以现代构成手法重新诠释。画面极度空旷，孤舟蓑笠翁被提炼为一个符号，强调孤独与坚守的精神内核。", en: "Based on traditional poetry but reinterpreted with modern composition. The vast emptiness isolates the boatman, symbolizing solitude and perseverance." } },
            { id: 10, src: "assets/images/gallery/eg10.jpg", title: { zh: "墨韵流光 No.10", en: "Flowing Ink No.10" }, year: "2024 · 180x97cm", desc: { zh: "探索水墨材料本身的流动性与偶然性。在创作过程中大量运用泼墨与冲水技法，让墨色在纸上自由流淌，形成不可复制的抽象肌理。", en: "Exploring the fluidity and chance of ink materials. Using splashing and washing techniques, ink flows freely on paper, creating unreproducible abstract textures." } },
            { id: 11, src: "assets/images/gallery/eg11.jpg", title: { zh: "春山烟雨 No.11", en: "Spring Mist No.11" }, year: "2023 · 138x69cm", desc: { zh: "以温润的笔触描绘春山的柔美。淡绿与浅赭色相互晕染，营造出一种朦胧、诗意的梦境感，展现了万物复苏的生机。", en: "Depicting the softness of spring mountains with gentle strokes. Light green and ochre blend to create a hazy, poetic dreamscape, showing the vitality of rebirth." } },
            { id: 12, src: "assets/images/gallery/eg12.jpg", title: { zh: "岩壑藏幽 No.12", en: "Hidden Valley No.12" }, year: "2022 · 200x100cm", desc: { zh: "巨幅作品，强调山石的体量感与压迫感。通过繁复的皴法与深沉的墨色，构建了一个深邃、神秘的岩壑世界，引人探幽。", en: "A massive work emphasizing the volume and presence of rocks. Complex texturing and deep ink build a profound, mysterious valley world that invites exploration." } }
        ];

        // 克隆数组实现无限循环（追加一份到末尾）
        const totalItemsCount = originalArtworks.length;
        const displayArtworks = [...originalArtworks, ...originalArtworks];

        let currentLang = 'zh';

        // === 语言 ===
        function updateUIText() {
            const t = uiText[currentLang];
            document.getElementById('ui-subtitle').innerText = t.subtitle;
            document.getElementById('ui-enter-btn').innerText = t.enterBtn;
            document.getElementById('ui-scroll-hint').innerText = t.scrollHint;
            document.getElementById('lang-btn').innerText = t.langBtn;

            document.querySelectorAll('.art-preview-title').forEach((el, index) => {
                if(displayArtworks[index]) el.innerText = displayArtworks[index].title[currentLang];
            });

            if(document.body.classList.contains('modal-open') && typeof currentArtIndex !== 'undefined') {
                 // 使用取模来获取原始数据，处理克隆后的索引
                 const art = originalArtworks[currentArtIndex % totalItemsCount];
                 document.getElementById('m-title').innerText = art.title[currentLang];
                 document.getElementById('m-desc').innerText = art.desc[currentLang];
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateUIText();
        }

        function checkLocation() {
            fetch('https://ipapi.co/json/').then(r => r.json()).then(d => {
                if (d.country_code && d.country_code !== 'CN') { currentLang = 'en'; updateUIText(); }
            }).catch(e => console.log("Loc check failed", e));
        }
        checkLocation();

        // === DOM 生成 ===
        const wrapper = document.getElementById('gallery-wrapper');
        const bgContainer = document.getElementById('bg-container');
        const isMobile = window.innerWidth < 768;
        
        // 布局参数 (vw)
        const itemWidthVw = isMobile ? 85 : 50; 
        const itemMarginVw = isMobile ? 5 : 10;
        const paddingLeftVw = isMobile ? 10 : 15;
        const singleItemTotalVw = itemWidthVw + itemMarginVw;
        
        // 1. 设置 wrapper 内边距
        wrapper.style.paddingLeft = `${paddingLeftVw}vw`;

        // 2. 生成背景层 (只需要生成原始数量)
        originalArtworks.forEach((art, index) => {
            const bgLayer = document.createElement('div');
            bgLayer.className = 'bg-layer';
            if(index === 0) bgLayer.classList.add('active');
            bgLayer.innerHTML = `<img src="${art.src}" class="bg-img" alt="bg">`;
            bgContainer.appendChild(bgLayer);
        });

        // 3. 生成画廊卡片 (包含克隆的)
        displayArtworks.forEach((art, index) => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            // 设置宽度和右边距
            item.style.width = `${itemWidthVw}vw`;
            item.style.marginRight = `${itemMarginVw}vw`;
            
            item.innerHTML = `
                <div class="art-card" onclick="openModal(${index})">
                    <img src="${art.src}" class="art-img" alt="Artwork" decoding="async">
                </div>
                <div class="art-preview-info">
                    <h2 class="art-preview-title">${art.title[currentLang]}</h2>
                    <p class="art-preview-meta">${art.year}</p>
                </div>
            `;
            wrapper.appendChild(item);
        });

        // 计算单次循环的总宽度 (像素)
        const viewportWidth = window.innerWidth;
        const oneSetWidthPx = (totalItemsCount * singleItemTotalVw) * (viewportWidth / 100);
        
        // 总宽度 = padding + 所有卡片宽度
        const totalVw = paddingLeftVw + (displayArtworks.length * singleItemTotalVw);
        wrapper.style.width = `${totalVw}vw`;

        // === 动画与滚动 ===
        gsap.registerPlugin(ScrollTrigger);

        const lenis = new Lenis({
            duration: 1.2,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            direction: 'vertical', 
            smooth: true,
            smoothTouch: true,
            touchMultiplier: 2
        });

        // GSAP ScrollTrigger: 将垂直滚动映射为水平移动
        const scrollTween = gsap.to(wrapper, {
            x: () => -(wrapper.scrollWidth - window.innerWidth),
            ease: "none",
            scrollTrigger: {
                trigger: ".gallery-container",
                pin: true,
                start: "top top",
                end: () => `+=${wrapper.scrollWidth - window.innerWidth}`,
                scrub: 0.5, // 稍微降低一点 scrub 让停止更跟手
                invalidateOnRefresh: true,
                onUpdate: (self) => {
                    // 背景切换逻辑 (取模 %)
                    const progress = self.progress;
                    const totalScrollWidth = wrapper.scrollWidth - window.innerWidth;
                    const currentX = progress * totalScrollWidth;
                    
                    // 计算当前在第几张图 (基于像素位置近似计算)
                    const itemFullWidthPx = (singleItemTotalVw * viewportWidth) / 100;
                    // 减去 padding 偏移
                    const effectiveX = Math.max(0, currentX - (paddingLeftVw * viewportWidth / 100) + (viewportWidth * 0.2)); 
                    let index = Math.floor(effectiveX / itemFullWidthPx);
                    
                    // 取模，映射回原始 12 张图
                    const realIndex = index % totalItemsCount;

                    const layers = document.querySelectorAll('.bg-layer');
                    layers.forEach((layer, i) => {
                        if (i === realIndex) {
                            if (!layer.classList.contains('active')) layer.classList.add('active');
                        } else {
                            if (layer.classList.contains('active')) layer.classList.remove('active');
                        }
                    });
                }
            }
        });

        gsap.to(".progress-bar", {
            width: "100%", ease: "none",
            scrollTrigger: { trigger: ".gallery-container", start: "top top", end: () => `+=${wrapper.scrollWidth - window.innerWidth}`, scrub: 0 }
        });

        // === 自动播放与循环逻辑 ===
        let isGalleryStarted = false;
        let isUserScrolling = false;
        let autoScrollSpeed = isMobile ? 0.8 : 1.5; 
        let scrollTimeout;
        let snapTimeout;

        function raf(time) {
            lenis.raf(time);
            
            // 核心逻辑：无限循环跳转
            // 如果滚动位置超过了第一组的总长度，瞬间拉回起点
            if (lenis.scroll >= oneSetWidthPx) {
                lenis.scrollTo(lenis.scroll - oneSetWidthPx, { immediate: true });
            }

            // 自动播放
            if (isGalleryStarted && !isUserScrolling && !document.body.classList.contains('modal-open')) {
                lenis.scrollTo(lenis.scroll + autoScrollSpeed, { immediate: true });
            }
            requestAnimationFrame(raf);
        }
        requestAnimationFrame(raf);

        // 监听用户交互
        ['pointerdown', 'touchstart', 'wheel'].forEach(evt => {
            window.addEventListener(evt, () => {
                if(isGalleryStarted) {
                    isUserScrolling = true;
                    clearTimeout(scrollTimeout);
                    clearTimeout(snapTimeout); // 用户操作时清除吸附倒计时
                }
            }, {passive: true});
        });

        lenis.on('scroll', () => {
            if(isGalleryStarted) {
                // 滚动停止检测
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if(!document.body.classList.contains('modal-open')) {
                        // 用户停止滚动后，先吸附，再恢复自动播放
                        performSnap();
                    }
                }, 100); // 停止 100ms 后触发逻辑
            }
        });

        // === 核心：精准吸附 (Snap) ===
        function performSnap() {
            if (!isGalleryStarted) return;

            // 计算一张图的像素宽度
            const itemPx = (singleItemTotalVw * window.innerWidth) / 100;
            const paddingPx = (paddingLeftVw * window.innerWidth) / 100;
            
            // 当前滚动位置
            const currentScroll = lenis.scroll;
            
            // 计算最近的图片索引 (round)
            // 目标位置 = index * itemPx
            // 考虑到 padding，我们需要微调。实际上 lenis.scroll 0 对应第一张图居中位置稍偏左
            // 简单算法：直接对 itemPx 取整
            let targetIndex = Math.round(currentScroll / itemPx);
            let targetScroll = targetIndex * itemPx;

            // 平滑吸附过去
            lenis.scrollTo(targetScroll, { 
                duration: 1.0, 
                easing: (t) => 1 - Math.pow(1 - t, 3), // cubicOut
                onComplete: () => {
                    // 吸附完成后，恢复自动慢速播放
                    isUserScrolling = false; 
                }
            });
        }

        // === 控制 ===
        const bgMusic = document.getElementById('bg-music');
        const introSection = document.getElementById('intro');
        const musicBtn = document.getElementById('music-toggle');

        function startGallery() {
            isGalleryStarted = true;
            document.body.classList.add('started');
            introSection.classList.add('hidden');
            
            // 启动时自动播放
            isUserScrolling = false;
        }

        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play();
                musicBtn.classList.remove('muted');
                musicBtn.classList.add('playing');
            } else {
                bgMusic.pause();
                musicBtn.classList.add('muted');
                musicBtn.classList.remove('playing');
            }
        }

        // === 弹窗 ===
        const modal = document.getElementById('detail-modal');
        const mImg = document.getElementById('modal-img');
        const mTitle = document.getElementById('m-title');
        const mMeta = document.getElementById('m-meta');
        const mDesc = document.getElementById('m-desc');
        let currentArtIndex = 0; 

        window.openModal = function(index) {
            // 这里 index 可能是克隆后的索引（比如 12, 13...）
            currentArtIndex = index;
            const realIndex = index % totalItemsCount;
            const data = originalArtworks[realIndex];
            
            mImg.src = data.src;
            mTitle.innerText = data.title[currentLang];
            mMeta.innerText = data.year;
            mDesc.innerText = data.desc[currentLang];
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
            lenis.stop(); // 停止底层滚动
        };

        function closeModal() {
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
            lenis.start(); // 恢复底层滚动
            // 延迟一点恢复自动播放，防止冲突
            setTimeout(() => { if(isGalleryStarted) isUserScrolling = false; }, 500);
        }
        document.getElementById('close-modal-btn').onclick = closeModal;
        modal.onclick = (e) => {
            if(e.target === modal || e.target.classList.contains('modal-content-box')) closeModal();
        };

    </script>
</body>
</html>
