<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yanxu | 晨光画境</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>

    <style>
        /* === 1. 基础设置与主题变量 === */
        :root {
            --text-dark: #1d1d1f;       
            --text-light: #86868b;      
            --accent-gold: #cfa858;     
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; 
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            background: #fdfbfb;
            color: var(--text-dark);
            overscroll-behavior: none; 
            /* 关键：禁止原生滚动和缩放，完全由 JS 接管触摸 */
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }

        html.lenis, html.lenis body { height: auto; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        /* === 2. Loading 界面 === */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 10000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .loading-text {
            font-size: 14px; color: var(--accent-gold); letter-spacing: 2px;
            margin-bottom: 15px; font-weight: 500;
        }
        .loading-bar-bg {
            width: 200px; height: 2px; background: rgba(0,0,0,0.05);
            border-radius: 2px; overflow: hidden;
        }
        .loading-bar-fill {
            width: 0%; height: 100%; background: var(--accent-gold);
            transition: width 0.2s linear;
        }

        /* === 3. 晨光流体背景 === */
        .morning-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #fffcf5, #fff5e6, #e6f0ff, #fffcf5);
            background-size: 400% 400%;
            animation: gradientFlow 20s ease infinite;
            transition: opacity 2s ease;
        }
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.3; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
        }
        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* === 4. 控制按钮 === */
        .controls-area {
            position: fixed; top: 25px; right: 25px; z-index: 800;
            display: flex; gap: 15px; align-items: center;
        }
        .control-btn {
            width: 42px; height: 42px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.4); 
            border: 1px solid #fff;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
            font-size: 12px; font-weight: 600; color: var(--text-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        body.started .control-btn { opacity: 1; transform: scale(1); }
        .control-btn:hover { background: #fff; transform: scale(1.1); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .music-btn svg { width: 18px; height: 18px; fill: var(--text-dark); }
        .music-btn.playing { background: #fff; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }

        /* === 5. 开场 Intro === */
        .intro-section {
            height: 100vh; width: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; 
            z-index: 900; 
            position: fixed; top:0; left:0;
            background: rgba(255,252,248, 1);
            transition: opacity 1.5s ease-in-out, visibility 1.5s;
        }
        
        .intro-content {
            transform: translateY(-5vh); 
            opacity: 0; transition: opacity 1s ease;
            display: flex; flex-direction: column; align-items: center;
        }
        .intro-content.visible { opacity: 1; }
        .intro-section.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .intro-title { 
            font-size: 10vw; font-weight: 700; letter-spacing: 8px; margin: 0; 
            background: linear-gradient(45deg, #8b5e3c, #cfa858);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 10px 20px rgba(207, 168, 88, 0.15));
        }
        .intro-subtitle { font-size: 1.2rem; color: var(--text-light); margin-top: 20px; letter-spacing: 4px; font-weight: 400; }
        
        .scroll-to-enter-hint {
            margin-top: 80px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            color: var(--accent-gold); font-size: 12px; letter-spacing: 2px;
            animation: pulseFade 2s infinite;
        }
        .scroll-icon {
            width: 24px; height: 40px; border: 1.5px solid var(--accent-gold);
            border-radius: 12px; position: relative;
        }
        .scroll-icon::after {
            content: ''; position: absolute; top: 6px; left: 50%; transform: translateX(-50%);
            width: 2px; height: 6px; background: var(--accent-gold); border-radius: 2px;
            animation: scrollDown 1.5s infinite;
        }

        @keyframes pulseFade { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        @keyframes scrollDown { 0% { top: 6px; opacity: 1; } 100% { top: 20px; opacity: 0; } }

        /* === 6. 画廊轨道 (视差) === */
        .gallery-container {
            width: 100%; height: 100vh;
            overflow: hidden; display: flex; align-items: center;
            opacity: 0; transform: scale(0.96); 
            transition: opacity 2s ease, transform 2s cubic-bezier(0.22, 1, 0.36, 1); 
            position: relative; z-index: 10; 
        }
        body.started .gallery-container { opacity: 1; transform: scale(1); }

        .gallery-wrapper {
            display: flex; align-items: center; flex-wrap: nowrap;
            height: 100%; 
            will-change: transform; 
        }

        .gallery-item {
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center;
            height: 100%; flex-shrink: 0; position: relative;
        }

        .art-card {
            position: relative; width: 100%; height: 60vh; 
            overflow: hidden; cursor: pointer;
            background: #fff; padding: 10px;
            box-shadow: 0 20px 60px rgba(166, 124, 82, 0.1);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.4s ease;
            transform: translateZ(0); 
            border-radius: 2px;
        }
        .art-card:hover { transform: scale(1.02) translateY(-10px); box-shadow: 0 40px 80px rgba(166, 124, 82, 0.2); }

        /* 视差容器 */
        .art-card-inner {
            width: 120%; 
            height: 100%;
            position: relative;
            left: -10%; 
            will-change: transform;
        }

        .art-img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.8s ease; 
        }
        .art-card:hover .art-img { transform: scale(1.08); }

        .art-preview-info {
            margin-top: 25px; padding-left: 5px; opacity: 1;
            width: 100%; transform: translateZ(0); 
        }
        .art-preview-title { font-size: 22px; font-weight: 600; margin: 0 0 6px 0; letter-spacing: 1px; color: var(--text-dark); }
        .art-preview-meta { font-size: 13px; color: var(--text-light); letter-spacing: 0.5px; font-weight: 400;}
        
        /* === 7. 液态玻璃弹窗 === */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            z-index: 999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        .modal.active { opacity: 1; pointer-events: auto; }

        .modal-content-box {
            position: relative; width: 85vw; height: 85vh; max-width: 1300px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.05), inset 0 0 30px rgba(255,255,255,0.8);
            backdrop-filter: blur(20px) saturate(120%);
            -webkit-backdrop-filter: blur(20px) saturate(120%);
            display: flex; flex-direction: column;
            transform: scale(0.9); opacity: 0;
            overflow: hidden;
        }
        
        .modal-img-wrapper {
            flex: 1; width: 100%;
            display: flex; justify-content: center; align-items: center;
            padding: 30px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.2));
            overflow: hidden;
        }
        .modal-img { 
            width: auto; height: auto; 
            max-width: 100%; max-height: 100%; 
            object-fit: contain; 
            box-shadow: 0 15px 40px rgba(139, 94, 60, 0.15); 
            border-radius: 4px;
        }

        .modal-text {
            width: 100%; 
            border-top: 1px solid rgba(255,255,255,0.6);
            display: flex; flex-direction: column;
            background: rgba(255,255,255,0.3);
            max-height: 60%; 
        }

        @media (min-width: 1024px) {
            .modal-content-box { flex-direction: row; }
            .modal-img-wrapper { height: 100%; width: 60%; border-right: 1px solid rgba(255,255,255,0.6); border-bottom: none; padding: 50px;}
            .modal-text { height: 100%; width: 40%; border-top: none; max-height: 100%; }
        }

        .modal-text-inner {
            padding: 40px; height: 100%;
            display: flex; flex-direction: column; justify-content: center;
            overflow: hidden; 
        }
        .modal-title { font-size: 30px; font-weight: 700; margin: 0 0 10px 0; letter-spacing: 1px; color: #1d1d1f; flex-shrink: 0; }
        
        .modal-meta-row {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 25px;
            letter-spacing: 0.5px;
            color: #86868b; font-size: 14px; font-weight: 500;
            flex-shrink: 0;
        }
        .modal-meta-divider { margin: 0 2px; opacity: 0.5; }
        .modal-views-text {
            display: flex; align-items: center; gap: 5px;
            font-size: 14px;
        }
        .modal-views-text svg { width: 15px; height: 15px; fill: #86868b; }

        .modal-desc-scroll {
            font-size: 15px; line-height: 1.8; text-align: justify; color: #424245; 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 10px;
            /* 关键：允许弹窗内滚动 */
            touch-action: pan-y;
            overscroll-behavior: contain; 
            -webkit-overflow-scrolling: touch;
            user-select: text;
        }
        .modal-desc-scroll::-webkit-scrollbar { width: 5px; background: rgba(0,0,0,0.03); }
        .modal-desc-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .modal-desc-scroll::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }

        .close-btn {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px; border-radius: 50%;
            background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            color: #333; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s; z-index: 100;
        }
        .close-btn:hover { background: var(--accent-gold); color: #fff; transform: rotate(90deg) scale(1.1); }

        .progress-bar {
            position: fixed; bottom: 0; left: 0; height: 5px; 
            background: linear-gradient(90deg, #cfa858, #f0e68c);
            width: 0%; z-index: 850;
        }
        
        @media (max-width: 768px) {
            .intro-title { font-size: 12vw; }
            .art-card { height: 50vh; }
            .modal-content-box { width: 95vw; height: 92vh; border-radius: 16px; flex-direction: column;}
            .modal-img-wrapper { height: 40%; padding: 20px; }
            .modal-text { height: 60%; width: 100%; border-top: 1px solid rgba(255,255,255,0.6); max-height: 60%; }
            .modal-text-inner { padding: 25px; justify-content: flex-start; }
            .modal-title { font-size: 24px; margin-bottom: 5px;}
            .modal-desc-scroll { font-size: 15px; margin-top: 10px;} 
            .controls-area { top: 20px; right: 20px; gap: 10px; }
            .scroll-to-enter-hint { margin-top: 50px; }
        }
    </style>
</head>
<body>

    <div class="loading-screen" id="loading-screen">
        <div class="loading-text">LOADING <span id="loading-percent">0%</span></div>
        <div class="loading-bar-bg">
            <div class="loading-bar-fill" id="loading-fill"></div>
        </div>
    </div>

    <div class="morning-bg"></div>
    <div class="noise-overlay"></div>

    <audio id="bg-music" loop preload="auto">
        <source src="assets/music/还是会想你曼波.mp3" type="audio/mpeg">
    </audio>

    <div class="controls-area">
        <div class="control-btn lang-btn" id="lang-btn" onclick="toggleLanguage()">EN</div>
        <div class="control-btn music-btn muted" id="music-toggle" onclick="toggleMusic()">
            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
        </div>
    </div>

    <div class="progress-bar"></div>

    <div class="modal" id="detail-modal">
        <div class="modal-content-box">
            <div class="close-btn" id="close-modal-btn">✕</div>
            <div class="modal-img-wrapper">
                <img src="" alt="" class="modal-img" id="modal-img">
            </div>
            <div class="modal-text">
                <div class="modal-text-inner">
                    <div class="modal-title" id="m-title"></div>
                    
                    <div class="modal-meta-row">
                        <span id="m-year"></span>
                        <span class="modal-meta-divider">|</span>
                        <div class="modal-views-text">
                            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                            <span id="m-views"></span>
                        </div>
                    </div>

                    <div class="modal-desc-scroll" id="m-desc"></div>
                </div>
            </div>
        </div>
    </div>

    <section class="intro-section" id="intro">
        <div class="intro-content" id="intro-content">
            <h1 class="intro-title">YANXU</h1>
            <p class="intro-subtitle" id="ui-subtitle">CHINESE PAINTING · 晨光画境</p>
            <div class="scroll-to-enter-hint">
                <div class="scroll-icon"></div>
                <span id="scroll-hint-text">SCROLL TO ENTER</span>
            </div>
        </div>
    </section>

    <div class="gallery-container">
        <div class="gallery-wrapper" id="gallery-wrapper">
        </div>
    </div>

    <script>
        // === 1. 数据配置 ===
        const longTextZh = "<br><br>在这幅作品中，不仅展示了技法的高超，更融入了画家对于晨光与生命的深刻哲思。画面中每一笔都经过深思熟虑，墨色的浓淡变化极其丰富，仿佛在诉说着一个关于时间与永恒的故事。<br><br>观者在驻足凝视时，往往能感受到一种超越视觉的心灵震撼。画中的留白并非空无一物，而是充满了气的流动，是此时无声胜有声的最佳写照。晨光熹微，不仅是自然景象，更是心境的映照。";
        const longTextEn = "<br><br>This artwork is not merely a display of technique but a profound meditation on morning light and life. Every stroke is deliberate, with the nuanced variations of ink narrating a story of time and eternity.<br><br>As viewers gaze upon the piece, they often experience a spiritual resonance that transcends the visual. The negative space is far from empty; it pulses with the flow of Qi, perfectly embodying the silence that speaks louder than words. The first light of dawn reflects not just the natural world, but the inner landscape of the soul.";

        const uiText = {
            zh: { subtitle: "CHINESE PAINTING · 晨光画境", scrollHint: "滑动进入画境", langBtn: "EN" },
            en: { subtitle: "CHINESE PAINTING · Art of Morning Light", scrollHint: "SCROLL TO ENTER", langBtn: "中" }
        };

        const originalArtworks = [
            { id: 1, src: "assets/images/gallery/eg1.jpg", title: { zh: "晨光熹微 No.1", en: "First Light No.1" }, year: "2023 · 138x69cm", views: 1204, desc: { zh: "笔墨在晨光中苏醒，捕捉第一缕阳光穿透云雾的瞬间。画面运用了传统的积墨法与现代的光影构成，试图在混沌中寻找秩序与希望。" + longTextZh, en: "Ink and brush awaken amidst the morning light, capturing the fleeting moment sunlight pierces through the mist. Employing traditional ink layering with modern light composition, the piece seeks order and hope within chaos." + longTextEn } },
            { id: 2, src: "assets/images/gallery/eg2.jpg", title: { zh: "山间清风 No.2", en: "Mountain Breeze No.2" }, year: "2023 · 69x69cm", views: 892, desc: { zh: "以清透的淡彩与水墨交融，表现山间清风拂过林梢的动态。留白的处理旨在营造空灵幽远的意境，强调人与自然的和谐共生。" + longTextZh, en: "Translucent watercolors blend with ink to express the dynamic breeze sweeping through treetops. The masterful use of negative space creates an ethereal atmosphere, emphasizing the harmonious coexistence of man and nature." + longTextEn } },
            { id: 3, src: "assets/images/gallery/eg3.jpg", title: { zh: "古木幽鸣 No.3", en: "Ancient Echoes No.3" }, year: "2022 · 180x97cm", views: 2431, desc: { zh: "聚焦于古树的肌理与沧桑感。通过焦墨与宿墨的对比，强化了古木盘根错节的生命力，仿佛能听到历史的回响。", en: "Focusing on the texture and vicissitudes of ancient trees. The stark contrast between dry and accumulated ink highlights the intertwined vitality of the roots, echoing the sounds of history." } },
            { id: 4, src: "assets/images/gallery/eg4.jpg", title: { zh: "溪山行旅 No.4", en: "Travels in Mountains No.4" }, year: "2023 · 138x34cm", views: 1567, desc: { zh: "向传统宋画致敬的长卷构图。在狭长的空间中安排了多重透视，引导观者视线随溪流而上，体验可行、可望、可游的境界。", en: "A tribute to Song Dynasty landscape painting in a long scroll format. Multiple perspectives guide the viewer upstream, creating an immersive journey through a landscape that is walkable, visible, and livable." } },
            { id: 5, src: "assets/images/gallery/eg5.jpg", title: { zh: "云蒸霞蔚 No.5", en: "Rising Clouds No.5" }, year: "2024 · 90x90cm", views: 3210, desc: { zh: "大胆运用朱砂与石青色，描绘日出时分云蒸霞蔚的壮观景象。色彩的碰撞与融合，旨在表现自然界瞬息万变的磅礴能量。", en: "Bold use of Cinnabar and Mineral Blue depicts the magnificent spectacle of sunrise. The collision and fusion of colors express the majestic and ever-changing energy of nature." } },
            { id: 6, src: "assets/images/gallery/eg6.jpg", title: { zh: "静谧之境 No.6", en: "Serenity No.6" }, year: "2022 · 69x45cm", views: 780, desc: { zh: "极简主义风格。大部分画面留白，仅在角落以简练的笔触勾勒出一石一草，追求“少即是多”的禅意表达。", en: "A minimalist composition. Most of the paper remains untouched, with simple strokes outlining a single stone and grass in the corner, pursuing the Zen expression of 'less is more'." } },
            { id: 7, src: "assets/images/gallery/eg7.jpg", title: { zh: "雨后初晴 No.7", en: "After the Rain No.7" }, year: "2023 · 138x69cm", views: 1890, desc: { zh: "利用湿画法表现雨后山石润泽、空气清新的质感。画面中水气氤氲，仿佛能闻到泥土的芬芳。", en: "Using wet wash techniques to render the moist texture of rocks and fresh air after rain. The misty atmosphere evokes the scent of damp earth." } },
            { id: 8, src: "assets/images/gallery/eg8.jpg", title: { zh: "秋山红叶 No.8", en: "Autumn Hills No.8" }, year: "2023 · 120x120cm", views: 2105, desc: { zh: "满幅构图，以热烈的色彩表现秋山的丰富层次。墨色作为骨架，承载着斑斓的色彩。", en: "A full composition using warm, vibrant colors to depict the rich layers of autumn hills. Ink serves as the structural skeleton supporting the brilliant palette." } },
            { id: 9, src: "assets/images/gallery/eg9.jpg", title: { zh: "寒江独钓 No.9", en: "Solitary Fishing No.9" }, year: "2022 · 69x69cm", views: 1432, desc: { zh: "取材于传统诗意，现代构成诠释。画面极度空旷，孤舟蓑笠翁被提炼为一个符号，强调孤独与坚守的精神内核。", en: "Based on traditional poetry but reinterpreted with modern composition. The vast emptiness isolates the boatman, transforming him into a symbol of solitude and perseverance." } },
            { id: 10, src: "assets/images/gallery/eg10.jpg", title: { zh: "墨韵流光 No.10", en: "Flowing Ink No.10" }, year: "2024 · 180x97cm", views: 998, desc: { zh: "探索水墨材料本身的流动性。泼墨与冲水让墨色在纸上自由流淌，形成不可复制的抽象肌理。", en: "Exploring the fluidity of ink itself. Splashing and washing techniques allow the ink to flow freely on paper, creating unreproducible abstract textures." } },
            { id: 11, src: "assets/images/gallery/eg11.jpg", title: { zh: "春山烟雨 No.11", en: "Spring Mist No.11" }, year: "2023 · 138x69cm", views: 1678, desc: { zh: "温润的笔触描绘春山。淡绿与浅赭色相互晕染，营造出一种朦胧、诗意的梦境感。", en: "Depicting the softness of spring mountains with gentle strokes. Light green and ochre blend to create a hazy, poetic dreamscape." } },
            { id: 12, src: "assets/images/gallery/eg12.jpg", title: { zh: "岩壑藏幽 No.12", en: "Hidden Valley No.12" }, year: "2022 · 200x100cm", views: 2540, desc: { zh: "巨幅作品，强调山石的体量感。繁复皴法与深沉墨色构建了一个深邃、神秘的岩壑世界。", en: "A massive work emphasizing the volume and presence of rocks. Complex texturing and deep ink tones build a profound, mysterious valley world." } }
        ];

        // 克隆数组实现无限循环
        const totalItemsCount = originalArtworks.length;
        const displayArtworks = [...originalArtworks, ...originalArtworks];

        let currentLang = 'zh';

        // === 2. 语言切换逻辑 ===
        function updateUIText() {
            const t = uiText[currentLang];
            document.getElementById('ui-subtitle').innerText = t.subtitle;
            document.getElementById('scroll-hint-text').innerText = t.scrollHint;
            document.getElementById('lang-btn').innerText = t.langBtn;

            document.querySelectorAll('.art-preview-title').forEach((el, index) => {
                if(displayArtworks[index]) el.innerText = displayArtworks[index].title[currentLang];
            });

            if(document.body.classList.contains('modal-open') && typeof currentArtIndex !== 'undefined') {
                 const art = originalArtworks[currentArtIndex % totalItemsCount];
                 document.getElementById('m-title').innerText = art.title[currentLang];
                 document.getElementById('m-desc').innerHTML = art.desc[currentLang];
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateUIText();
        }

        // === 3. 预加载逻辑 ===
        function preloadImages() {
            const loadingScreen = document.getElementById('loading-screen');
            const percentEl = document.getElementById('loading-percent');
            const fillEl = document.getElementById('loading-fill');
            const introContent = document.getElementById('intro-content');

            const imagesToLoad = [...new Set(originalArtworks.map(a => a.src))];
            let loadedCount = 0;
            const total = imagesToLoad.length;

            if(total === 0) {
                finishLoading();
                return;
            }

            imagesToLoad.forEach(src => {
                const img = new Image();
                img.onload = () => { loadedCount++; updateProgress(); };
                img.onerror = () => { loadedCount++; updateProgress(); };
                img.src = src;
            });

            function updateProgress() {
                const percent = Math.round((loadedCount / total) * 100);
                percentEl.innerText = percent + "%";
                fillEl.style.width = percent + "%";
                if(loadedCount >= total) setTimeout(finishLoading, 500);
            }

            function finishLoading() {
                loadingScreen.classList.add('hidden');
                introContent.classList.add('visible'); 
            }
        }

        // === 4. DOM 生成 ===
        const wrapper = document.getElementById('gallery-wrapper');
        const isMobile = window.innerWidth < 768;
        
        const itemWidthVw = isMobile ? 85 : 50; 
        const itemMarginVw = isMobile ? 5 : 8; 
        const paddingLeftVw = isMobile ? 8 : 15;
        const singleItemTotalVw = itemWidthVw + itemMarginVw;
        
        wrapper.style.paddingLeft = `${paddingLeftVw}vw`;

        // 生成画廊卡片
        displayArtworks.forEach((art, index) => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.style.width = `${itemWidthVw}vw`;
            item.style.marginRight = `${itemMarginVw}vw`;
            
            // 视差结构
            item.innerHTML = `
                <div class="art-card" onclick="openModal(${index})">
                    <div class="art-card-inner">
                        <img src="${art.src}" class="art-img" alt="Artwork" decoding="async">
                    </div>
                </div>
                <div class="art-preview-info">
                    <h2 class="art-preview-title">${art.title[currentLang]}</h2>
                    <p class="art-preview-meta">${art.year}</p>
                </div>
            `;
            wrapper.appendChild(item);
        });

        const totalVw = paddingLeftVw + (displayArtworks.length * singleItemTotalVw);
        wrapper.style.width = `${totalVw}vw`;
        
        // 计算无限循环的节点宽度
        const oneSetWidthPx = (totalItemsCount * singleItemTotalVw) * (window.innerWidth / 100);

        preloadImages();

        // === 5. Lenis & ScrollTrigger ===
        gsap.registerPlugin(ScrollTrigger);

        const lenis = new Lenis({
            duration: 1.0, 
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            direction: 'vertical', 
            smooth: true,
            smoothTouch: true,
            touchMultiplier: 2.5 
        });

        const scrollTween = gsap.to(wrapper, {
            x: () => -(wrapper.scrollWidth - window.innerWidth),
            ease: "none",
            scrollTrigger: {
                trigger: ".gallery-container",
                pin: true,
                start: "top top",
                end: () => `+=${wrapper.scrollWidth - window.innerWidth}`,
                scrub: 0.1, 
                invalidateOnRefresh: true,
            }
        });

        // 视差动画
        gsap.utils.toArray(".art-card-inner").forEach((inner, i) => {
            gsap.fromTo(inner, 
                { xPercent: -8 }, 
                { 
                    xPercent: 8, 
                    ease: "none",
                    scrollTrigger: {
                        trigger: inner.closest(".gallery-item"),
                        containerAnimation: scrollTween, 
                        start: "left right", 
                        end: "right left",   
                        scrub: true
                    }
                }
            );
        });

        gsap.to(".progress-bar", {
            width: "100%", ease: "none",
            scrollTrigger: { 
                trigger: ".gallery-container", 
                start: "top top", 
                end: () => `+=${wrapper.scrollWidth - window.innerWidth}`, 
                scrub: 0 
            }
        });

        // === 6. 核心逻辑：触控反转与无限循环 ===
        let isGalleryStarted = false;
        let isUserScrolling = false;
        let isTouching = false; // 新增：严格的触摸状态锁
        let autoScrollSpeed = isMobile ? 1.0 : 1.8; 
        let scrollTimeout;

        // 监听滚动以触发“进入画境”
        lenis.on('scroll', (e) => {
            if (!isGalleryStarted) {
                if (e.animatedScroll > 50) startGallery();
            } else {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    // 只有当手指不在屏幕上时，才允许执行吸附
                    if(!document.body.classList.contains('modal-open') && !isTouching) {
                        performSnap();
                    }
                }, 200); 
            }
        });

        // == 移动端触控逻辑 (严格冲突解决) ==
        let touchStartX = 0;
        let touchStartY = 0;
        
        window.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            
            // 只要按下，立即锁定
            isTouching = true;
            isUserScrolling = true;
            clearTimeout(scrollTimeout);
        }, {passive: false});

        window.addEventListener('touchmove', (e) => {
            // 如果弹窗打开，放行（让 mDesc 处理），否则执行反转逻辑
            if(document.body.classList.contains('modal-open')) return;
            if(!isGalleryStarted) return;

            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;

            // 水平滑动主导
            if(Math.abs(deltaX) > Math.abs(deltaY)) {
                e.preventDefault(); 
                
                // 修复逻辑：手指左滑 (deltaX < 0) -> 内容向左滚动 -> Scroll 增加
                const sensitivity = 3.5;
                lenis.scrollTo(lenis.scroll + (Math.abs(deltaX) * (deltaX > 0 ? -1 : 1) * sensitivity), { immediate: true });
                
                touchStartX = touchX;
            }
        }, {passive: false});

        window.addEventListener('touchend', () => {
            isTouching = false; 
            // 这里不立即设置 isUserScrolling=false，而是交给 lenis.on('scroll') 里的 timeout 处理
            // 这样可以等待惯性滑动结束
        });

        // === 新增：键盘控制 ===
        window.addEventListener('keydown', (e) => {
            if(document.body.classList.contains('modal-open')) return;
            if(!isGalleryStarted) return;

            const step = window.innerWidth * 0.5; 

            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                isUserScrolling = true;
                lenis.scrollTo(lenis.scroll + step);
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                isUserScrolling = true;
                lenis.scrollTo(lenis.scroll - step);
            }
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                isUserScrolling = false;
            }, 500);
        });

        // === 动画帧循环 ===
        function raf(time) {
            lenis.raf(time);
            
            // 无限循环逻辑
            if (lenis.scroll >= oneSetWidthPx) {
                lenis.scrollTo(lenis.scroll % oneSetWidthPx, { immediate: true });
            }

            // 自动播放：必须同时满足三个条件
            // 1. 画廊已开始
            // 2. 用户没有在操作 (isUserScrolling)
            // 3. 手指没有在屏幕上 (isTouching) -- 修复冲突的关键
            if (isGalleryStarted && !isUserScrolling && !isTouching && !document.body.classList.contains('modal-open')) {
                lenis.scrollTo(lenis.scroll + autoScrollSpeed, { immediate: true });
            }
            requestAnimationFrame(raf);
        }
        requestAnimationFrame(raf);

        ['pointerdown', 'wheel'].forEach(evt => {
            window.addEventListener(evt, () => {
                if(isGalleryStarted) {
                    isUserScrolling = true;
                    clearTimeout(scrollTimeout);
                }
            }, {passive: true});
        });

        function performSnap() {
            if (!isGalleryStarted) return;
            const itemPx = (singleItemTotalVw * window.innerWidth) / 100;
            const currentScroll = lenis.scroll;
            
            let targetIndex = Math.round(currentScroll / itemPx);
            let targetScroll = targetIndex * itemPx;

            lenis.scrollTo(targetScroll, { 
                duration: 1.0, 
                easing: (t) => 1 - Math.pow(1 - t, 3), 
                onComplete: () => { isUserScrolling = false; }
            });
        }

        // === 7. 交互逻辑 ===
        const bgMusic = document.getElementById('bg-music');
        const introSection = document.getElementById('intro');
        const musicBtn = document.getElementById('music-toggle');

        function startGallery() {
            if(isGalleryStarted) return;
            isGalleryStarted = true;
            document.body.classList.add('started');
            
            introSection.classList.add('hidden');
            
            ScrollTrigger.refresh();
            isUserScrolling = false;
        }

        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play();
                musicBtn.classList.remove('muted');
                musicBtn.classList.add('playing');
            } else {
                bgMusic.pause();
                musicBtn.classList.add('muted');
                musicBtn.classList.remove('playing');
            }
        }

        // === 8. 弹窗与 GSAP 动画 ===
        const modal = document.getElementById('detail-modal');
        const mImg = document.getElementById('modal-img');
        const mTitle = document.getElementById('m-title');
        const mYear = document.getElementById('m-year');
        const mViews = document.getElementById('m-views');
        const mDesc = document.getElementById('m-desc');
        let currentArtIndex = 0; 

        window.openModal = function(index) {
            currentArtIndex = index;
            const realIndex = index % totalItemsCount;
            const data = originalArtworks[realIndex];
            
            mImg.src = data.src;
            mTitle.innerText = data.title[currentLang];
            mYear.innerText = data.year;
            mViews.innerText = data.views; 
            mDesc.innerHTML = data.desc[currentLang];
            mDesc.scrollTop = 0; 
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
            
            lenis.stop();
            isUserScrolling = true;

            const box = modal.querySelector('.modal-content-box');
            gsap.fromTo(box, 
                { scale: 0.8, opacity: 0 },
                { scale: 1, opacity: 1, duration: 0.5, ease: "back.out(1.2)" }
            );
        };

        function closeModal() {
            const box = modal.querySelector('.modal-content-box');
            gsap.to(box, {
                scale: 0.9, opacity: 0, duration: 0.3, ease: "power2.in",
                onComplete: () => {
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                    lenis.start();
                    setTimeout(() => { if(isGalleryStarted) isUserScrolling = false; }, 500);
                }
            });
        }
        document.getElementById('close-modal-btn').onclick = closeModal;
        modal.onclick = (e) => {
            if(e.target === modal) closeModal();
        };

        // 单独处理详情页滚动条的触摸事件，防止事件冒泡
        mDesc.addEventListener('touchmove', (e) => {
            e.stopPropagation();
        }, { passive: false });

    </script>
</body>
</html>
