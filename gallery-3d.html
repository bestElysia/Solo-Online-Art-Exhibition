<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yanxu | 晨光画境</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>

    <style>
        /* === 1. 基础设置与主题变量 === */
        :root {
            --text-dark: #4a3b2a;       
            --text-light: #8b7d6b;      
            --accent-gold: #cfa858;     
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; 
            min-height: 100vh;
            font-family: "Songti SC", "Noto Serif SC", serif;
            -webkit-font-smoothing: antialiased;
            background: #fdfbfb;
            color: var(--text-dark);
            overscroll-behavior: none; 
        }

        html.lenis, html.lenis body { height: auto; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        /* === 2. 晨光流体背景 === */
        .morning-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #fffcf5, #fff5e6, #e6f0ff, #fffcf5);
            background-size: 400% 400%;
            animation: gradientFlow 20s ease infinite;
            transition: opacity 2s ease;
        }

        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.3; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* === 3. 控制按钮 === */
        .controls-area {
            position: fixed; top: 25px; right: 25px; z-index: 800;
            display: flex; gap: 15px; align-items: center;
        }

        .control-btn {
            width: 42px; height: 42px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.4); 
            border: 1px solid #fff;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
            font-size: 12px; font-weight: bold; color: var(--text-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        body.started .control-btn { opacity: 1; transform: scale(1); }
        .control-btn:hover { background: #fff; transform: scale(1.1); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        
        .music-btn svg { width: 18px; height: 18px; fill: var(--text-dark); }
        .music-btn.playing { background: #fff; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }

        /* === 4. 开场 Intro === */
        .intro-section {
            height: 100vh; width: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; 
            z-index: 900; 
            position: fixed; top:0; left:0;
            background: rgba(255,252,248, 1);
            transition: opacity 1.5s ease-in-out, visibility 1.5s;
        }
        
        /* 内容上移 */
        .intro-content {
            transform: translateY(-8vh); 
        }

        .intro-section.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .intro-title { 
            font-size: 10vw; font-weight: 800; letter-spacing: 10px; margin: 0; 
            background: linear-gradient(45deg, #8b5e3c, #cfa858);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 10px 20px rgba(207, 168, 88, 0.2));
        }
        .intro-subtitle { font-size: 1.2rem; color: var(--text-light); margin-top: 20px; letter-spacing: 5px; }
        
        .start-btn {
            margin-top: 60px; padding: 15px 45px;
            border: none; color: #fff;
            font-size: 14px; letter-spacing: 4px;
            background: linear-gradient(90deg, #cfa858, #a67c52);
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(166, 124, 82, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .start-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(166, 124, 82, 0.4); }

        /* === 5. 画廊轨道 === */
        .gallery-container {
            width: 100%; height: 100vh;
            overflow: hidden; display: flex; align-items: center;
            opacity: 0; transform: scale(0.95); 
            transition: opacity 2s ease, transform 2s cubic-bezier(0.22, 1, 0.36, 1); 
            position: relative; z-index: 10; 
        }
        body.started .gallery-container { opacity: 1; transform: scale(1); }

        .gallery-wrapper {
            display: flex; align-items: center; flex-wrap: nowrap;
            height: 100%; 
            will-change: transform; 
        }

        .gallery-item {
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center;
            height: 100%; flex-shrink: 0; position: relative;
        }

        .art-card {
            position: relative; width: 100%; height: 60vh; 
            overflow: hidden; cursor: pointer;
            background: #fff; padding: 10px;
            box-shadow: 0 20px 60px rgba(166, 124, 82, 0.15);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.4s ease;
            transform: translateZ(0); 
        }
        .art-card:hover { transform: scale(1.02) translateY(-10px); box-shadow: 0 40px 80px rgba(166, 124, 82, 0.25); }

        .art-img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.8s ease; will-change: transform;
        }
        .art-card:hover .art-img { transform: scale(1.08); }

        .art-preview-info {
            margin-top: 25px; padding-left: 5px; opacity: 1;
            width: 100%; transform: translateZ(0); 
        }
        .art-preview-title { font-size: 24px; font-weight: bold; margin: 0 0 8px 0; letter-spacing: 2px; color: var(--text-dark); }
        .art-preview-meta { font-size: 14px; color: var(--text-light); font-family: sans-serif; letter-spacing: 1px;}
        
        /* === 6. 液态玻璃弹窗 === */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        .modal.active { opacity: 1; pointer-events: auto; }

        .modal-content-box {
            position: relative; width: 85vw; height: 85vh; max-width: 1300px;
            background: rgba(255, 255, 255, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.08), inset 0 0 30px rgba(255,255,255,0.8);
            backdrop-filter: blur(20px) saturate(120%);
            -webkit-backdrop-filter: blur(20px) saturate(120%);
            display: flex; flex-direction: column;
            transform: scale(0.9); opacity: 0;
            overflow: hidden;
        }
        
        .modal-img-wrapper {
            flex: 1; width: 100%;
            display: flex; justify-content: center; align-items: center;
            padding: 30px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.2));
            overflow: hidden;
        }
        .modal-img { 
            width: auto; height: auto; 
            max-width: 100%; max-height: 100%; 
            object-fit: contain; 
            box-shadow: 0 15px 40px rgba(139, 94, 60, 0.15); 
            border-radius: 4px;
            /* 移除放大鼠标指针 */
        }

        .modal-text {
            width: 100%; 
            border-top: 1px solid rgba(255,255,255,0.6);
            display: flex; flex-direction: column;
            background: rgba(255,255,255,0.25);
        }

        @media (min-width: 1024px) {
            .modal-content-box { flex-direction: row; }
            .modal-img-wrapper { height: 100%; width: 60%; border-right: 1px solid rgba(255,255,255,0.6); border-bottom: none; padding: 50px;}
            .modal-text { height: 100%; width: 40%; border-top: none; }
        }

        .modal-text-inner {
            padding: 40px; height: 100%;
            display: flex; flex-direction: column; justify-content: center;
        }
        .modal-title { font-size: 32px; font-weight: 900; margin: 0 0 10px 0; letter-spacing: 2px; color: #3d2e22; }
        
        /* 详情页元数据行：年份 + 浏览量 */
        .modal-meta-row {
            display: flex; align-items: center; gap: 20px;
            margin-bottom: 25px;
            font-family: sans-serif; letter-spacing: 1px;
            color: #9c8c74; font-size: 14px;
        }
        .modal-views-box {
            display: flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.4);
            padding: 4px 10px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.6);
        }
        .modal-views-box svg { width: 14px; height: 14px; fill: #9c8c74; }

        .modal-desc-scroll {
            font-size: 16px; line-height: 1.8; text-align: justify; color: #594a3a; 
            max-height: 45vh; overflow-y: auto; padding-right: 15px;
            overscroll-behavior: contain; -webkit-overflow-scrolling: touch;
        }
        .modal-desc-scroll::-webkit-scrollbar { width: 6px; }
        .modal-desc-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.03); }
        .modal-desc-scroll::-webkit-scrollbar-thumb { background: rgba(139, 94, 60, 0.2); border-radius: 10px; }

        .close-btn {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px; border-radius: 50%;
            background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            color: #333; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s; z-index: 100;
        }
        .close-btn:hover { background: var(--accent-gold); color: #fff; transform: rotate(90deg) scale(1.1); }

        .progress-bar {
            position: fixed; bottom: 0; left: 0; height: 5px; 
            background: linear-gradient(90deg, #cfa858, #f0e68c);
            width: 0%; z-index: 850;
        }
        
        @media (max-width: 768px) {
            .intro-title { font-size: 12vw; }
            .art-card { height: 50vh; }
            .modal-content-box { width: 95vw; height: 92vh; border-radius: 16px; flex-direction: column;}
            .modal-img-wrapper { height: 40%; padding: 20px; }
            .modal-text { height: 60%; width: 100%; border-top: 1px solid rgba(255,255,255,0.6); }
            .modal-text-inner { padding: 25px; justify-content: flex-start; }
            .modal-title { font-size: 24px; margin-bottom: 5px;}
            .modal-desc-scroll { max-height: 100%; font-size: 15px; margin-top: 10px;} 
            .controls-area { top: 20px; right: 20px; gap: 10px; }
        }
    </style>
</head>
<body>

    <div class="morning-bg"></div>
    <div class="noise-overlay"></div>

    <audio id="bg-music" loop preload="auto">
        <source src="assets/music/还是会想你曼波.mp3" type="audio/mpeg">
    </audio>

    <div class="controls-area">
        <div class="control-btn lang-btn" id="lang-btn" onclick="toggleLanguage()">EN</div>
        <div class="control-btn music-btn muted" id="music-toggle" onclick="toggleMusic()">
            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
        </div>
    </div>

    <div class="progress-bar"></div>

    <div class="modal" id="detail-modal">
        <div class="modal-content-box">
            <div class="close-btn" id="close-modal-btn">✕</div>
            <div class="modal-img-wrapper">
                <img src="" alt="" class="modal-img" id="modal-img">
            </div>
            <div class="modal-text">
                <div class="modal-text-inner">
                    <div class="modal-title" id="m-title"></div>
                    
                    <div class="modal-meta-row">
                        <span id="m-year"></span>
                        <div class="modal-views-box">
                            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                            <span id="m-views"></span>
                        </div>
                    </div>

                    <div class="modal-desc-scroll" id="m-desc"></div>
                </div>
            </div>
        </div>
    </div>

    <section class="intro-section" id="intro">
        <div class="intro-content">
            <h1 class="intro-title">YANXU</h1>
            <p class="intro-subtitle" id="ui-subtitle">CHINESE PAINTING · 晨光画境</p>
            <button class="start-btn" id="ui-enter-btn" onclick="startGallery()">进入画境</button>
        </div>
    </section>

    <div class="gallery-container">
        <div class="gallery-wrapper" id="gallery-wrapper">
            </div>
    </div>

    <script>
        // === 1. 数据配置 ===
        const longTextZh = "<br><br>在这幅作品中，不仅展示了技法的高超，更融入了画家对于晨光与生命的深刻哲思。画面中每一笔都经过深思熟虑，墨色的浓淡变化极其丰富，仿佛在诉说着一个关于时间与永恒的故事。<br><br>观者在驻足凝视时，往往能感受到一种超越视觉的心灵震撼。画中的留白并非空无一物，而是充满了气的流动，是此时无声胜有声的最佳写照。晨光熹微，不仅是自然景象，更是心境的映照。";
        const longTextEn = "<br><br>This artwork incorporates the artist's profound philosophy on morning light and life. Every stroke is deliberate, with rich variations in ink tone, telling a story about time and eternity.<br><br>Viewers often feel a spiritual shock beyond vision. The negative space is not empty but full of the flow of Qi. The morning light reflects not just nature, but the state of mind.";

        const uiText = {
            zh: { subtitle: "CHINESE PAINTING · 晨光画境", enterBtn: "进入画境", langBtn: "EN" },
            en: { subtitle: "CHINESE PAINTING · Art of Morning Light", enterBtn: "ENTER GALLERY", langBtn: "中" }
        };

        const originalArtworks = [
            { id: 1, src: "assets/images/gallery/eg1.jpg", title: { zh: "晨光熹微 No.1", en: "First Light No.1" }, year: "2023 · 138x69cm", views: 1204, desc: { zh: "笔墨在晨光中苏醒，捕捉第一缕阳光穿透云雾的瞬间。画面运用了传统的积墨法与现代的光影构成，试图在混沌中寻找秩序与希望。" + longTextZh, en: "Ink awakens in the morning light. Using traditional ink layering with modern composition, it seeks order and hope amidst chaos." + longTextEn } },
            { id: 2, src: "assets/images/gallery/eg2.jpg", title: { zh: "山间清风 No.2", en: "Mountain Breeze No.2" }, year: "2023 · 69x69cm", views: 892, desc: { zh: "以清透的淡彩与水墨交融，表现山间清风拂过林梢的动态。留白的处理旨在营造空灵幽远的意境，强调人与自然的和谐共生。" + longTextZh, en: "Clear watercolors blend with ink to express the breeze sweeping through treetops. The negative space creates an ethereal atmosphere." + longTextEn } },
            { id: 3, src: "assets/images/gallery/eg3.jpg", title: { zh: "古木幽鸣 No.3", en: "Ancient Echoes No.3" }, year: "2022 · 180x97cm", views: 2431, desc: { zh: "聚焦于古树的肌理与沧桑感。通过焦墨与宿墨的对比，强化了古木盘根错节的生命力，仿佛能听到历史的回响。", en: "Focusing on the texture of ancient trees. The contrast between dry and accumulated ink highlights the intertwined vitality." } },
            { id: 4, src: "assets/images/gallery/eg4.jpg", title: { zh: "溪山行旅 No.4", en: "Travels in Mountains No.4" }, year: "2023 · 138x34cm", views: 1567, desc: { zh: "向传统宋画致敬的长卷构图。在狭长的空间中安排了多重透视，引导观者视线随溪流而上，体验可行、可望、可游的境界。", en: "A tribute to Song Dynasty landscape painting. Multiple perspectives guide the viewer upstream, creating an immersive journey." } },
            { id: 5, src: "assets/images/gallery/eg5.jpg", title: { zh: "云蒸霞蔚 No.5", en: "Rising Clouds No.5" }, year: "2024 · 90x90cm", views: 3210, desc: { zh: "大胆运用朱砂与石青色，描绘日出时分云蒸霞蔚的壮观景象。色彩的碰撞与融合，旨在表现自然界瞬息万变的磅礴能量。", en: "Bold use of Cinnabar and Mineral Blue depicts the magnificent sunrise. The collision of colors expresses majestic energy." } },
            { id: 6, src: "assets/images/gallery/eg6.jpg", title: { zh: "静谧之境 No.6", en: "Serenity No.6" }, year: "2022 · 69x45cm", views: 780, desc: { zh: "极简主义风格。大部分画面留白，仅在角落以简练的笔触勾勒出一石一草，追求“少即是多”的禅意表达。", en: "A minimalist piece. Most of the paper is left blank, pursuing the Zen expression of 'less is more'." } },
            { id: 7, src: "assets/images/gallery/eg7.jpg", title: { zh: "雨后初晴 No.7", en: "After the Rain No.7" }, year: "2023 · 138x69cm", views: 1890, desc: { zh: "利用湿画法表现雨后山石润泽、空气清新的质感。画面中水气氤氲，仿佛能闻到泥土的芬芳。", en: "Using wet wash techniques to show the moist texture of rocks after rain. The misty atmosphere evokes the scent of earth." } },
            { id: 8, src: "assets/images/gallery/eg8.jpg", title: { zh: "秋山红叶 No.8", en: "Autumn Hills No.8" }, year: "2023 · 120x120cm", views: 2105, desc: { zh: "满幅构图，以热烈的色彩表现秋山的丰富层次。墨色作为骨架，承载着斑斓的色彩。", en: "Full composition using warm colors to show the rich layers of autumn hills. Ink serves as the skeleton supporting vibrant colors." } },
            { id: 9, src: "assets/images/gallery/eg9.jpg", title: { zh: "寒江独钓 No.9", en: "Solitary Fishing No.9" }, year: "2022 · 69x69cm", views: 1432, desc: { zh: "取材于传统诗意，现代构成诠释。画面极度空旷，孤舟蓑笠翁被提炼为一个符号，强调孤独与坚守的精神内核。", en: "Based on traditional poetry but reinterpreted. The vast emptiness isolates the boatman, symbolizing solitude and perseverance." } },
            { id: 10, src: "assets/images/gallery/eg10.jpg", title: { zh: "墨韵流光 No.10", en: "Flowing Ink No.10" }, year: "2024 · 180x97cm", views: 998, desc: { zh: "探索水墨材料本身的流动性。泼墨与冲水让墨色在纸上自由流淌，形成不可复制的抽象肌理。", en: "Exploring ink fluidity. Splashing and washing create unreproducible abstract textures." } },
            { id: 11, src: "assets/images/gallery/eg11.jpg", title: { zh: "春山烟雨 No.11", en: "Spring Mist No.11" }, year: "2023 · 138x69cm", views: 1678, desc: { zh: "温润的笔触描绘春山。淡绿与浅赭色相互晕染，营造出一种朦胧、诗意的梦境感。", en: "Depicting soft spring mountains. Light green and ochre blend to create a hazy, poetic dreamscape." } },
            { id: 12, src: "assets/images/gallery/eg12.jpg", title: { zh: "岩壑藏幽 No.12", en: "Hidden Valley No.12" }, year: "2022 · 200x100cm", views: 2540, desc: { zh: "巨幅作品，强调山石的体量感。繁复皴法与深沉墨色构建了一个深邃、神秘的岩壑世界。", en: "A massive work emphasizing rock volume. Complex texturing builds a profound, mysterious valley world." } }
        ];

        // 克隆数组实现无限循环
        const totalItemsCount = originalArtworks.length;
        const displayArtworks = [...originalArtworks, ...originalArtworks];

        let currentLang = 'zh';

        // === 2. 语言切换逻辑 ===
        function updateUIText() {
            const t = uiText[currentLang];
            document.getElementById('ui-subtitle').innerText = t.subtitle;
            document.getElementById('ui-enter-btn').innerText = t.enterBtn;
            document.getElementById('lang-btn').innerText = t.langBtn;

            document.querySelectorAll('.art-preview-title').forEach((el, index) => {
                if(displayArtworks[index]) el.innerText = displayArtworks[index].title[currentLang];
            });

            if(document.body.classList.contains('modal-open') && typeof currentArtIndex !== 'undefined') {
                 const art = originalArtworks[currentArtIndex % totalItemsCount];
                 document.getElementById('m-title').innerText = art.title[currentLang];
                 document.getElementById('m-desc').innerHTML = art.desc[currentLang];
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateUIText();
        }

        // === 3. DOM 生成 ===
        const wrapper = document.getElementById('gallery-wrapper');
        const isMobile = window.innerWidth < 768;
        
        const itemWidthVw = isMobile ? 85 : 50; 
        const itemMarginVw = isMobile ? 5 : 8; 
        const paddingLeftVw = isMobile ? 8 : 15;
        const singleItemTotalVw = itemWidthVw + itemMarginVw;
        
        wrapper.style.paddingLeft = `${paddingLeftVw}vw`;

        // 生成画廊卡片
        displayArtworks.forEach((art, index) => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.style.width = `${itemWidthVw}vw`;
            item.style.marginRight = `${itemMarginVw}vw`;
            
            // 外面只保留年份，移除了浏览量
            item.innerHTML = `
                <div class="art-card" onclick="openModal(${index})">
                    <img src="${art.src}" class="art-img" alt="Artwork" decoding="async">
                </div>
                <div class="art-preview-info">
                    <h2 class="art-preview-title">${art.title[currentLang]}</h2>
                    <p class="art-preview-meta">${art.year}</p>
                </div>
            `;
            wrapper.appendChild(item);
        });

        const totalVw = paddingLeftVw + (displayArtworks.length * singleItemTotalVw);
        wrapper.style.width = `${totalVw}vw`;
        
        const viewportWidth = window.innerWidth;
        const oneSetWidthPx = (totalItemsCount * singleItemTotalVw) * (viewportWidth / 100);

        // === 4. Lenis & ScrollTrigger (终极流畅配置) ===
        gsap.registerPlugin(ScrollTrigger);

        const lenis = new Lenis({
            duration: 1.2,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            direction: 'vertical', 
            smooth: true,
            smoothTouch: true,
            touchMultiplier: 3 
        });

        const scrollTween = gsap.to(wrapper, {
            x: () => -(wrapper.scrollWidth - window.innerWidth),
            ease: "none",
            scrollTrigger: {
                trigger: ".gallery-container",
                pin: true,
                start: "top top",
                end: () => `+=${wrapper.scrollWidth - window.innerWidth}`,
                scrub: 0.5, 
                invalidateOnRefresh: true,
            }
        });

        gsap.to(".progress-bar", {
            width: "100%", ease: "none",
            scrollTrigger: { 
                trigger: ".gallery-container", 
                start: "top top", 
                end: () => `+=${wrapper.scrollWidth - window.innerWidth}`, 
                scrub: 0 
            }
        });

        // === 5. 循环逻辑 ===
        let isGalleryStarted = false;
        let isUserScrolling = false;
        let autoScrollSpeed = isMobile ? 1.0 : 1.8; 
        let scrollTimeout;

        function raf(time) {
            lenis.raf(time);
            
            // 无限循环
            if (lenis.scroll >= oneSetWidthPx) {
                lenis.scrollTo(lenis.scroll - oneSetWidthPx, { immediate: true });
            }

            // 自动播放
            if (isGalleryStarted && !isUserScrolling && !document.body.classList.contains('modal-open')) {
                lenis.scrollTo(lenis.scroll + autoScrollSpeed, { immediate: true });
            }
            requestAnimationFrame(raf);
        }
        requestAnimationFrame(raf);

        ['pointerdown', 'touchstart', 'wheel'].forEach(evt => {
            window.addEventListener(evt, () => {
                if(isGalleryStarted) {
                    isUserScrolling = true;
                    clearTimeout(scrollTimeout);
                }
            }, {passive: true});
        });

        lenis.on('scroll', () => {
            if(isGalleryStarted) {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if(!document.body.classList.contains('modal-open')) {
                        performSnap();
                    }
                }, 200); 
            }
        });

        function performSnap() {
            if (!isGalleryStarted) return;
            const itemPx = (singleItemTotalVw * window.innerWidth) / 100;
            const currentScroll = lenis.scroll;
            
            let targetIndex = Math.round(currentScroll / itemPx);
            let targetScroll = targetIndex * itemPx;

            lenis.scrollTo(targetScroll, { 
                duration: 1.0, 
                easing: (t) => 1 - Math.pow(1 - t, 3), 
                onComplete: () => { isUserScrolling = false; }
            });
        }

        // === 6. 交互逻辑 ===
        const bgMusic = document.getElementById('bg-music');
        const introSection = document.getElementById('intro');
        const musicBtn = document.getElementById('music-toggle');

        function startGallery() {
            isGalleryStarted = true;
            document.body.classList.add('started');
            
            // Intro 淡出
            introSection.classList.add('hidden');
            
            ScrollTrigger.refresh();
            isUserScrolling = false;
        }

        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play();
                musicBtn.classList.remove('muted');
                musicBtn.classList.add('playing');
            } else {
                bgMusic.pause();
                musicBtn.classList.add('muted');
                musicBtn.classList.remove('playing');
            }
        }

        // === 7. 弹窗与 GSAP 动画 ===
        const modal = document.getElementById('detail-modal');
        const mImg = document.getElementById('modal-img');
        const mTitle = document.getElementById('m-title');
        const mYear = document.getElementById('m-year');
        const mViews = document.getElementById('m-views');
        const mDesc = document.getElementById('m-desc');
        let currentArtIndex = 0; 

        window.openModal = function(index) {
            currentArtIndex = index;
            const realIndex = index % totalItemsCount;
            const data = originalArtworks[realIndex];
            
            mImg.src = data.src;
            mTitle.innerText = data.title[currentLang];
            mYear.innerText = data.year;
            mViews.innerText = data.views; // 静态数据，如需随机可在这里 Math.random()
            mDesc.innerHTML = data.desc[currentLang];
            mDesc.scrollTop = 0; 
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
            lenis.stop();

            // GSAP 弹窗进场动画
            const box = modal.querySelector('.modal-content-box');
            gsap.fromTo(box, 
                { scale: 0.8, opacity: 0 },
                { scale: 1, opacity: 1, duration: 0.5, ease: "back.out(1.2)" }
            );
        };

        function closeModal() {
            const box = modal.querySelector('.modal-content-box');
            // 离场动画
            gsap.to(box, {
                scale: 0.9, opacity: 0, duration: 0.3, ease: "power2.in",
                onComplete: () => {
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                    lenis.start();
                    setTimeout(() => { if(isGalleryStarted) isUserScrolling = false; }, 500);
                }
            });
        }
        document.getElementById('close-modal-btn').onclick = closeModal;
        modal.onclick = (e) => {
            if(e.target === modal) closeModal();
        };

    </script>
</body>
</html>
